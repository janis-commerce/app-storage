name: NPM Publish Beta

on:
    push:
        tags:
            - '*-beta*'
            - '*-alpha*'
            - '*-rc*'

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'
                  registry-url: https://registry.npmjs.org/

            - name: Install dependencies
              run: npm ci

            - name: Run linting
              run: npm run lint

    publish-npm:
        needs: build
        runs-on: ubuntu-latest
        environment: beta
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'
                  registry-url: https://registry.npmjs.org/

            - name: Install dependencies
              run: npm ci

            - name: Determine npm tag
              id: npm-tag
              run: |
                  if [[ ${{ github.ref_name }} == *"-alpha"* ]]; then
                    echo "tag=alpha" >> $GITHUB_OUTPUT
                  elif [[ ${{ github.ref_name }} == *"-rc"* ]]; then
                    echo "tag=rc" >> $GITHUB_OUTPUT
                  else
                    echo "tag=beta" >> $GITHUB_OUTPUT
                  fi

            - name: Publish to NPM
              run: npm publish --tag ${{ steps.npm-tag.outputs.tag }} --access public
              env:
                  NODE_AUTH_TOKEN: ${{secrets.npm_token}}

    send-slack-message:
        needs: publish-npm
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'

            - name: Send beta release notification
              run: bash ./scripts/release-notes.sh
              env:
                  RELEASE_SLACK_WEBHOOK_URL: ${{ secrets.RELEASE_SLACK_WEBHOOK_URL }}
